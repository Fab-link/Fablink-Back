name: Deploy Backend

# develop/master ë¸Œëœì¹˜ì— pushë˜ê±°ë‚˜ PRì´ ìƒì„±ë  ë•Œ ì‹¤í–‰
on:
  push:
    branches: [ develop, master ]  # develop(deví™˜ê²½), master(prodí™˜ê²½) ë¸Œëœì¹˜ ì§€ì›
  pull_request:
    branches: [ develop, master ]  # PR ìƒì„± ì‹œ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰

env:
  AWS_REGION: ap-northeast-2

jobs:
  # ë¹Œë“œ ë° ë°°í¬ (develop/master ë¸Œëœì¹˜ push ì‹œì—ë§Œ ì‹¤í–‰)
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    environment: AWS  # AWS í™˜ê²½ ì‚¬ìš©
    # develop ë˜ëŠ” master ë¸Œëœì¹˜ì— pushë  ë•Œë§Œ ë°°í¬ (PR ë¨¸ì§€ ì™„ë£Œ í›„)
    if: (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set environment variables
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          echo "ğŸ¯ Deploying to PRODUCTION environment"
          echo "ECR_REPOSITORY=fablink-backend" >> $GITHUB_ENV
          echo "EKS_CLUSTER_NAME=fablink-cluster-prod" >> $GITHUB_ENV
          echo "KUBERNETES_NAMESPACE=fablink-prod" >> $GITHUB_ENV
          echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          echo "API_GATEWAY_URL=https://bjqxlrmmi6.execute-api.ap-northeast-2.amazonaws.com/prod" >> $GITHUB_ENV
        else
          echo "ğŸ¯ Deploying to DEVELOPMENT environment"
          echo "ECR_REPOSITORY=fablink-backend-dev" >> $GITHUB_ENV
          echo "EKS_CLUSTER_NAME=fablink-cluster-dev" >> $GITHUB_ENV
          echo "KUBERNETES_NAMESPACE=fablink-dev" >> $GITHUB_ENV
          echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          echo "API_GATEWAY_URL=https://8wwdg03sr6.execute-api.ap-northeast-2.amazonaws.com" >> $GITHUB_ENV
        fi

    - name: Debug AWS credentials
      run: |
        echo "ğŸ” Checking AWS credentials setup..."
        echo "AWS_ACCESS_KEY_ID exists: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}"
        echo "AWS_SECRET_ACCESS_KEY exists: ${{ secrets.AWS_SECRET_ACCESS_KEY != '' }}"
        echo "AWS_REGION: ${{ env.AWS_REGION }}"
        echo "Environment: ${{ env.ENVIRONMENT }}"
        echo "ECR Repository: ${{ env.ECR_REPOSITORY }}"
        echo "EKS Cluster: ${{ env.EKS_CLUSTER_NAME }}"
        echo "Namespace: ${{ env.KUBERNETES_NAMESPACE }}"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸ”¨ Building Docker image for ${{ env.ENVIRONMENT }} environment..."
        echo "ğŸ“¦ Image will be tagged as: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        
        # Build and push image
        docker buildx build \
          --platform linux/amd64 \
          --build-arg ENV=${{ env.ENVIRONMENT }} \
          --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          --push .
        
        echo "âœ… Docker image pushed successfully!"

    - name: Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Update kubeconfig
      run: |
        echo "ğŸ”§ Configuring kubectl for EKS cluster..."
        aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME

    - name: Deploy to EKS
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸš€ Deploying to ${{ env.ENVIRONMENT }} environment..."
        echo "ğŸ¯ Target: $KUBERNETES_NAMESPACE namespace"
        
        # Update deployment image
        kubectl set image deployment/fablink-backend \
          fablink-backend=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          -n $KUBERNETES_NAMESPACE

        echo "â³ Waiting for rollout to complete..."
        # Wait for rollout to complete
        kubectl rollout status deployment/fablink-backend -n $KUBERNETES_NAMESPACE --timeout=300s

    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        
        # Check pod status
        echo "ğŸ“Š Pod Status:"
        kubectl get pods -n $KUBERNETES_NAMESPACE -l app=fablink-backend
        
        # Check service status
        echo "ğŸŒ Service Status:"
        kubectl get svc -n $KUBERNETES_NAMESPACE
        
        # Wait a bit for pod to be ready
        sleep 10
        
        # Test health endpoint
        echo "ğŸ¥ Testing health endpoint..."
        kubectl exec -n $KUBERNETES_NAMESPACE \
          deployment/fablink-backend -- \
          curl -f http://localhost:8000/health/ || exit 1
        
        echo "âœ… Health check passed!"

    - name: Deployment Summary
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo ""
          echo "ğŸ‰ =================================="
          echo "âœ… ${{ env.ENVIRONMENT }} Environment Deployment SUCCESS!"
          echo "=================================="
          echo "ğŸ”— API Gateway: ${{ env.API_GATEWAY_URL }}"
          echo "ğŸ“š Swagger UI: ${{ env.API_GATEWAY_URL }}/api/docs/"
          echo "ğŸ“– ReDoc: ${{ env.API_GATEWAY_URL }}/api/redoc/"
          echo "ğŸ¥ Health Check: ${{ env.API_GATEWAY_URL }}/health/"
          echo "ğŸ“Š Ready Check: ${{ env.API_GATEWAY_URL }}/ready/"
          echo ""
          echo "ğŸ³ Docker Image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
          echo "ğŸ·ï¸  Git Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ¯ Environment: ${{ env.ENVIRONMENT }}"
          echo "=================================="
        else
          echo ""
          echo "âŒ =================================="
          echo "ğŸ’¥ ${{ env.ENVIRONMENT }} Environment Deployment FAILED!"
          echo "=================================="
          echo "ğŸ” Please check the logs above for details."
          echo "ğŸ› Debug steps:"
          echo "   1. Check pod logs: kubectl logs -n ${{ env.KUBERNETES_NAMESPACE }} deployment/fablink-backend"
          echo "   2. Check pod status: kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }}"
          echo "   3. Check events: kubectl get events -n ${{ env.KUBERNETES_NAMESPACE }}"
          echo "=================================="
          exit 1
        fi
    - name: Extract Jira ticket from commit
      id: jira-ticket
      run: |
        # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ FABLINK-XXX íŒ¨í„´ ì¶”ì¶œ
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        JIRA_TICKET=$(echo "$COMMIT_MSG" | grep -oE 'FABLINK-[0-9]+' | head -1)
        
        # ë§Œì•½ ì»¤ë°‹ ë©”ì‹œì§€ì— ì—†ìœ¼ë©´ ë¨¸ì§€ ì»¤ë°‹ì—ì„œ ì¶”ì¶œ ì‹œë„
        if [ -z "$JIRA_TICKET" ]; then
          # ë¨¸ì§€ ì»¤ë°‹ ë©”ì‹œì§€ í˜•íƒœ: "Merge pull request #XX from user/FABLINK-152"
          JIRA_TICKET=$(echo "$COMMIT_MSG" | grep -oE 'from [^/]+/(FABLINK-[0-9]+)' | sed 's/from [^/]+\///')
        fi
        
        # ì—¬ì „íˆ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
        if [ -z "$JIRA_TICKET" ]; then
          JIRA_TICKET="${{ github.ref_name }}"
        fi
        
        echo "JIRA_TICKET=$JIRA_TICKET" >> $GITHUB_OUTPUT
        echo "ğŸ« Extracted Jira ticket: $JIRA_TICKET"

    - name: Send Slack notification
      if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ ì‹¤í–‰
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#back'  # ìŠ¬ë™ ì±„ë„ëª… (ì‹¤ì œ ì±„ë„ëª…ìœ¼ë¡œ ë³€ê²½)
        text: |
          ğŸš€ Backend ë°°í¬ ì•Œë¦¼
          
          ğŸ“‹ ì§€ë¼ í‹°ì¼“: <https://fablink.atlassian.net/jira/software/projects/FABLINK/boards/1/timeline?selectedIssue=${{ steps.jira-ticket.outputs.JIRA_TICKET }}|${{ steps.jira-ticket.outputs.JIRA_TICKET }}>
          ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}
          ğŸ¯ í™˜ê²½: ${{ env.ENVIRONMENT }}
          ğŸ‘¤ ì‘ì—…ì: ${{ github.actor }}
          ğŸ“… ì‹œê°„: ${{ github.event.head_commit.timestamp }}
          
          ${{ job.status == 'success' && 'âœ… ë°°í¬ ì„±ê³µ!' || 'âŒ ë°°í¬ ì‹¤íŒ¨!' }}
          
          ${{ job.status == 'success' && format('ğŸ”— API: {0}', env.API_GATEWAY_URL) || 'ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    - name: Extract Jira ticket from commit
      id: jira-ticket
      run: |
        echo "ğŸ” Extracting Jira ticket..."
        echo "Commit message: '${{ github.event.head_commit.message }}'"
        
        # ë°©ë²• 1: ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ FABLINK-XXX íŒ¨í„´ ì¶”ì¶œ
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        JIRA_TICKET=$(echo "$COMMIT_MSG" | grep -oE 'FABLINK-[0-9]+' | head -1)
        echo "Method 1 (commit message): '$JIRA_TICKET'"
        
        # ë°©ë²• 2: ë¨¸ì§€ ì»¤ë°‹ì—ì„œ ì¶”ì¶œ ì‹œë„
        if [ -z "$JIRA_TICKET" ]; then
          # "Merge pull request #XX from user/FABLINK-152" í˜•íƒœ
          JIRA_TICKET=$(echo "$COMMIT_MSG" | sed -n 's/.*from [^/]*\/\(FABLINK-[0-9]\+\).*/\1/p')
          echo "Method 2 (merge commit): '$JIRA_TICKET'"
        fi
        
        # ì°¾ì§€ ëª»í•˜ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
        if [ -z "$JIRA_TICKET" ]; then
          JIRA_TICKET="FABLINK-Unknown"
          echo "Fallback: '$JIRA_TICKET'"
        fi
        
        echo "JIRA_TICKET=$JIRA_TICKET" >> $GITHUB_OUTPUT
        echo "ğŸ« Final Jira ticket: $JIRA_TICKET"
