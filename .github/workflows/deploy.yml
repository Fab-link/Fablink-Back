name: Deploy Backend

# develop/master Î∏åÎûúÏπòÏóê pushÎêòÍ±∞ÎÇò PRÏù¥ ÏÉùÏÑ±Îê† Îïå Ïã§Ìñâ
on:
  push:
    branches: [ develop, master ]  # develop(devÌôòÍ≤Ω), master(prodÌôòÍ≤Ω) Î∏åÎûúÏπò ÏßÄÏõê
  pull_request:
    branches: [ develop, master ]  # PR ÏÉùÏÑ± Ïãú ÌÖåÏä§Ìä∏Îßå Ïã§Ìñâ

env:
  AWS_REGION: ap-northeast-2

jobs:
  # ÎπåÎìú Î∞è Î∞∞Ìè¨ (develop/master Î∏åÎûúÏπò push ÏãúÏóêÎßå Ïã§Ìñâ)
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    environment: AWS  # AWS ÌôòÍ≤Ω ÏÇ¨Ïö©
    # develop ÎòêÎäî master Î∏åÎûúÏπòÏóê pushÎê† ÎïåÎßå Î∞∞Ìè¨ (PR Î®∏ÏßÄ ÏôÑÎ£å ÌõÑ)
    if: (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set environment variables
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          echo "üéØ Deploying to PRODUCTION environment"
          echo "ECR_REPOSITORY=fablink-backend" >> $GITHUB_ENV
          echo "EKS_CLUSTER_NAME=fablink-cluster-prod" >> $GITHUB_ENV
          echo "KUBERNETES_NAMESPACE=fablink-prod" >> $GITHUB_ENV
          echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          echo "API_GATEWAY_URL=https://bjqxlrmmi6.execute-api.ap-northeast-2.amazonaws.com/prod" >> $GITHUB_ENV
        else
          echo "üéØ Deploying to DEVELOPMENT environment"
          echo "ECR_REPOSITORY=fablink-backend-dev" >> $GITHUB_ENV
          echo "EKS_CLUSTER_NAME=fablink-cluster-dev" >> $GITHUB_ENV
          echo "KUBERNETES_NAMESPACE=fablink-dev" >> $GITHUB_ENV
          echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          echo "API_GATEWAY_URL=https://8wwdg03sr6.execute-api.ap-northeast-2.amazonaws.com" >> $GITHUB_ENV
        fi

    - name: Debug AWS credentials
      run: |
        echo "üîç Checking AWS credentials setup..."
        echo "AWS_ACCESS_KEY_ID exists: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}"
        echo "AWS_SECRET_ACCESS_KEY exists: ${{ secrets.AWS_SECRET_ACCESS_KEY != '' }}"
        echo "AWS_REGION: ${{ env.AWS_REGION }}"
        echo "Environment: ${{ env.ENVIRONMENT }}"
        echo "ECR Repository: ${{ env.ECR_REPOSITORY }}"
        echo "EKS Cluster: ${{ env.EKS_CLUSTER_NAME }}"
        echo "Namespace: ${{ env.KUBERNETES_NAMESPACE }}"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "üî® Building Docker image for ${{ env.ENVIRONMENT }} environment..."
        echo "üì¶ Image will be tagged as: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        
        # Build and push image
        docker buildx build \
          --platform linux/amd64 \
          --build-arg ENV=${{ env.ENVIRONMENT }} \
          --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          --push .
        
        echo "‚úÖ Docker image pushed successfully!"

    - name: Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Update kubeconfig
      run: |
        echo "üîß Configuring kubectl for EKS cluster..."
        aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME

    - name: Deploy to EKS
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "üöÄ Deploying to ${{ env.ENVIRONMENT }} environment..."
        echo "üéØ Target: $KUBERNETES_NAMESPACE namespace"
        
        # Update deployment image
        kubectl set image deployment/fablink-backend \
          fablink-backend=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          -n $KUBERNETES_NAMESPACE

        echo "‚è≥ Waiting for rollout to complete..."
        # Wait for rollout to complete
        kubectl rollout status deployment/fablink-backend -n $KUBERNETES_NAMESPACE --timeout=300s

    - name: Verify deployment
      run: |
        echo "üîç Verifying deployment..."
        
        # Check pod status
        echo "üìä Pod Status:"
        kubectl get pods -n $KUBERNETES_NAMESPACE -l app=fablink-backend
        
        # Check service status
        echo "üåê Service Status:"
        kubectl get svc -n $KUBERNETES_NAMESPACE
        
        # Wait a bit for pod to be ready
        sleep 10
        
        # Test health endpoint
        echo "üè• Testing health endpoint..."
        kubectl exec -n $KUBERNETES_NAMESPACE \
          deployment/fablink-backend -- \
          curl -f http://localhost:8000/health/ || exit 1
        
        echo "‚úÖ Health check passed!"

    - name: Deployment Summary
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo ""
          echo "üéâ =================================="
          echo "‚úÖ ${{ env.ENVIRONMENT }} Environment Deployment SUCCESS!"
          echo "=================================="
          echo "üîó API Gateway: ${{ env.API_GATEWAY_URL }}"
          echo "üìö Swagger UI: ${{ env.API_GATEWAY_URL }}/api/docs/"
          echo "üìñ ReDoc: ${{ env.API_GATEWAY_URL }}/api/redoc/"
          echo "üè• Health Check: ${{ env.API_GATEWAY_URL }}/health/"
          echo "üìä Ready Check: ${{ env.API_GATEWAY_URL }}/ready/"
          echo ""
          echo "üê≥ Docker Image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
          echo "üè∑Ô∏è  Git Commit: ${{ github.sha }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üë§ Author: ${{ github.actor }}"
          echo "üéØ Environment: ${{ env.ENVIRONMENT }}"
          echo "=================================="
        else
          echo ""
          echo "‚ùå =================================="
          echo "üí• ${{ env.ENVIRONMENT }} Environment Deployment FAILED!"
          echo "=================================="
          echo "üîç Please check the logs above for details."
          echo "üêõ Debug steps:"
          echo "   1. Check pod logs: kubectl logs -n ${{ env.KUBERNETES_NAMESPACE }} deployment/fablink-backend"
          echo "   2. Check pod status: kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }}"
          echo "   3. Check events: kubectl get events -n ${{ env.KUBERNETES_NAMESPACE }}"
          echo "=================================="
          exit 1
        fi
